<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AxionFit - Registro de Ingresos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Poppins',sans-serif;background:#f5f7fa;}
        .card{box-shadow:0 10px 25px rgba(0,0,0,.08);border:none;border-radius:15px;}
        .btn-primary-custom{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:#fff;}
        .btn-primary-custom:hover{transform:translateY(-2px);}
    </style>
</head>
<body>
<div class="container py-5">
    <div class="d-flex justify-content-end mb-3">
        <a href="index.html" class="btn btn-outline-primary"><i class="fas fa-arrow-left me-2"></i>Volver al Panel</a>
    </div>
    <h2 class="mb-4 text-center"><i class="fas fa-door-open me-2"></i>Registro de Ingresos</h2>
    <!-- Búsqueda Mejorada -->
    <div class="card p-4 mb-4">
        <h5 class="mb-3"><i class="fas fa-search me-2"></i>Búsqueda de Miembros</h5>
        <form id="formBuscar" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">ID del Miembro</label>
                <input type="number" id="inputMiembro" class="form-control" placeholder="Ej: 1">
            </div>
            <div class="col-md-3">
                <label class="form-label">Teléfono</label>
                <input type="text" id="inputTelefono" class="form-control" placeholder="Ej: 123-456-7890">
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary-custom btn-custom" type="submit">
                    <i class="fas fa-search me-2"></i>Buscar
                </button>
            </div>
            <div class="col-md-3">
                <button type="button" id="btnMostrarTodos" class="btn btn-outline-primary btn-custom">
                    <i class="fas fa-list me-2"></i>Ver Todos
                </button>
            </div>
        </form>
        
        <!-- Resultado de búsqueda individual -->
        <div id="resultadoBusqueda" class="mt-4 d-none">
            <div class="card bg-light p-3">
                <h5 class="text-primary mb-2">Miembro Encontrado:</h5>
                <div id="infoMiembro"></div>
                <button id="btnRegistrar" class="btn btn-success btn-custom mt-2">
                    <i class="fas fa-door-open me-2"></i>Registrar Ingreso
                </button>
            </div>
        </div>
    </div>
    
    <!-- Lista completa de miembros -->
    <div id="listaMiembrosContainer" class="card p-4 mb-4 d-none">
        <h5 class="mb-3"><i class="fas fa-users me-2"></i>Todos los Miembros</h5>
        <table id="tablaMiembros" class="table table-striped w-100">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre Completo</th>
                    <th>Teléfono</th>
                    <th>Vencimiento</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="card p-4">
        <h5 class="mb-3"><i class="fas fa-history me-2"></i>Historial de Ingresos</h5>
        <table id="tablaIngresos" class="table table-striped table-custom w-100">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Miembro ID</th>
                    <th>Fecha/Hora</th>
                    <th>Acción</th> <!-- Nueva columna -->
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Modal para Membresía Vencida -->
<div class="modal fade" id="modalVencimiento" tabindex="-1" aria-labelledby="modalVencimientoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalVencimientoLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>¡MEMBRESÍA VENCIDA!
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="alert alert-danger" role="alert">
          <i class="fas fa-calendar-times fa-3x mb-3 text-danger"></i>
          <h4 class="alert-heading">Membresía Vencida</h4>
          <p class="mb-3">El miembro <strong id="nombreMiembroVencido"></strong> tiene su membresía vencida desde el <strong id="fechaVencimiento"></strong>.</p>
          <hr>
          <p class="mb-0">Por favor, solicite al miembro que renueve su membresía antes de permitir el ingreso.</p>
        </div>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar Ingreso
          </button>
          <button type="button" class="btn btn-warning" id="btnPermitirIngresoVencido">
            <i class="fas fa-check me-2"></i>Permitir Ingreso (Excepcional)
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// GymStorage (simplificado, idéntico al usado en index.html)
class GymStorage{
    constructor(){this.init();}
    init(){
        if(!localStorage.getItem('gym_usuarios'))localStorage.setItem('gym_usuarios','[]');
        if(!localStorage.getItem('gym_ingresos'))localStorage.setItem('gym_ingresos','[]');
        if(!localStorage.getItem('gym_next_id'))localStorage.setItem('gym_next_id','1');
    }
    getNextId(){const n=parseInt(localStorage.getItem('gym_next_id'));localStorage.setItem('gym_next_id',String(n+1));return n;}
    getUsuarios(){return JSON.parse(localStorage.getItem('gym_usuarios')||'[]');}
    getUsuario(id){return this.getUsuarios().find(u=>u.id===parseInt(id));}
    getIngresos(){return JSON.parse(localStorage.getItem('gym_ingresos')||'[]');}
    addIngreso(i){const arr=this.getIngresos();i.id=this.getNextId();arr.push(i);localStorage.setItem('gym_ingresos',JSON.stringify(arr));}
}
const storage=new GymStorage();

// Función para verificar si una membresía está vencida
function estaVencida(fechaVencimiento) {
    const hoy = new Date();
    const vencimiento = new Date(fechaVencimiento);
    return vencimiento < hoy;
}

// Función para formatear fecha en español
function formatearFecha(fecha) {
    return new Date(fecha).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

// DataTable
const dt=$('#tablaIngresos').DataTable({language:{search:'Buscar:',lengthMenu:'Mostrar _MENU_',info:'_START_ - _END_ de _TOTAL_',paginate:{first:'Primero',last:'Último',next:'Siguiente',previous:'Anterior'},emptyTable:'Sin registros'},order:[[0,'desc']]});
function refrescarTabla(){
    const data = storage.getIngresos().map(i => [
        i.id,
        i.usuario_id,
        new Date(i.fecha).toLocaleString('es-ES'),
        `<button class='btn btn-sm btn-warning me-2' onclick='editarIngreso(${i.id})'>Editar</button>
         <button class='btn btn-sm btn-danger' onclick='eliminarIngreso(${i.id})'>Eliminar</button>`
    ]).sort((a, b) => b[0] - a[0]);
    dt.clear().rows.add(data).draw();
}
refrescarTabla();

// DataTable para lista de miembros
const tablaMiembros = $('#tablaMiembros').DataTable({
    destroy: true,
    columnDefs: [{ orderable: false, targets: 4 }],
    language: {
        search: 'Buscar:',
        lengthMenu: 'Mostrar _MENU_ registros',
        info: '_START_ - _END_ de _TOTAL_ registros',
        paginate: { first: 'Primero', last: 'Último', next: 'Siguiente', previous: 'Anterior' },
        emptyTable: 'No hay miembros registrados',
        zeroRecords: 'No se encontraron registros'
    }
});

// Buscar miembro (mejorado)
$('#formBuscar').on('submit', function(e) {
    e.preventDefault();
    const id = $('#inputMiembro').val().trim();
    const telefono = $('#inputTelefono').val().trim();
    
    let usuario = null;
    
    // Buscar por ID
    if (id) {
        usuario = storage.getUsuario(id);
    }
    // Buscar por teléfono si no se encontró por ID
    else if (telefono) {
        const usuarios = storage.getUsuarios();
        usuario = usuarios.find(u => u.telefono && u.telefono.includes(telefono));
    }
    
    if (usuario) {
        mostrarMiembro(usuario);
        $('#listaMiembrosContainer').addClass('d-none');
    } else {
        alert('Miembro no encontrado. Intente con otro ID o teléfono.');
        $('#resultadoBusqueda').addClass('d-none');
    }
});

// Función para mostrar información del miembro
function mostrarMiembro(usuario) {
    const vencida = estaVencida(usuario.fecha_vencimiento);
    const estadoClass = vencida ? 'text-danger' : 'text-success';
    const estadoTexto = vencida ? '⚠️ VENCIDA' : '✅ ACTIVA';
    
    const info = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>ID:</strong> ${usuario.id}</p>
                <p><strong>Nombre:</strong> ${usuario.nombre} ${usuario.apellido}</p>
                <p><strong>Teléfono:</strong> ${usuario.telefono || 'No especificado'}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Email:</strong> ${usuario.email || 'No especificado'}</p>
                <p><strong>Vencimiento:</strong> <span class="${estadoClass} fw-bold">${usuario.fecha_vencimiento} ${estadoTexto}</span></p>
                <p><strong>DNI:</strong> ${usuario.dni}</p>
            </div>
        </div>
    `;
    
    $('#infoMiembro').html(info);
    $('#btnRegistrar').data('uid', usuario.id);
    $('#resultadoBusqueda').removeClass('d-none');
}

// Mostrar todos los miembros
$('#btnMostrarTodos').on('click', function() {
    const usuarios = storage.getUsuarios();
    
    tablaMiembros.clear();
    tablaMiembros.rows.add(usuarios.map(u => {
        const vencida = estaVencida(u.fecha_vencimiento);
        const estadoClass = vencida ? 'text-danger fw-bold' : 'text-success';
        const estadoTexto = vencida ? '⚠️ VENCIDA' : '✅ ACTIVA';
        const btnClass = vencida ? 'btn-warning' : 'btn-success';
        
        return [
            u.id,
            `${u.nombre} ${u.apellido}`,
            u.telefono || 'Sin teléfono',
            `<span class="${estadoClass}">${u.fecha_vencimiento} ${estadoTexto}</span>`,
            `<button class="btn btn-sm ${btnClass}" onclick="registrarIngresoDirecto(${u.id}, '${u.nombre}', '${u.apellido}', '${u.fecha_vencimiento}')">
                <i class="fas fa-door-open me-1"></i>Registrar Ingreso
             </button>`
        ];
    }));
    tablaMiembros.draw();
    
    $('#listaMiembrosContainer').removeClass('d-none');
    $('#resultadoBusqueda').addClass('d-none');
});

// Registrar ingreso desde búsqueda individual
$('#btnRegistrar').on('click', function() {
    const id = $(this).data('uid');
    const usuario = storage.getUsuario(id);
    
    if (!usuario) {
        alert('Miembro no encontrado');
        return;
    }
    
    // Verificar si la membresía está vencida
    if (estaVencida(usuario.fecha_vencimiento)) {
        mostrarModalVencimiento(usuario);
        return;
    }
    
    // Si no está vencida, registrar ingreso normalmente
    registrarIngreso(usuario);
});

// Función para mostrar modal de vencimiento
function mostrarModalVencimiento(usuario) {
    $('#nombreMiembroVencido').text(`${usuario.nombre} ${usuario.apellido}`);
    $('#fechaVencimiento').text(formatearFecha(usuario.fecha_vencimiento));
    
    // Configurar botón para permitir ingreso excepcional
    $('#btnPermitirIngresoVencido').off('click').on('click', function() {
        registrarIngreso(usuario, true);
        $('#modalVencimiento').modal('hide');
    });
    
    $('#modalVencimiento').modal('show');
}

// Función para registrar ingreso
function registrarIngreso(usuario, esExcepcional = false) {
    storage.addIngreso({
        usuario_id: usuario.id,
        fecha: new Date().toISOString(),
        excepcional: esExcepcional
    });
    
    const mensaje = esExcepcional 
        ? `⚠️ Ingreso EXCEPCIONAL registrado para ${usuario.nombre} ${usuario.apellido} (Membresía vencida)`
        : `✅ Ingreso registrado para ${usuario.nombre} ${usuario.apellido}`;
    
    alert(mensaje);
    $('#resultadoBusqueda').addClass('d-none');
    $('#inputMiembro').val('');
    $('#inputTelefono').val('');
    refrescarTabla();
}

// Función global para registro directo desde tabla
function registrarIngresoDirecto(id, nombre, apellido, fechaVencimiento) {
    const usuario = storage.getUsuario(id);
    
    if (!usuario) {
        alert('Miembro no encontrado');
        return;
    }
    
    // Verificar si la membresía está vencida
    if (estaVencida(fechaVencimiento)) {
        mostrarModalVencimiento(usuario);
        return;
    }
    
    // Si no está vencida, registrar ingreso normalmente
    registrarIngreso(usuario);
}

// Función para editar un ingreso
function editarIngreso(id) {
    const ingresos = storage.getIngresos();
    const ingreso = ingresos.find(i => i.id === id);

    if (!ingreso) {
        alert('Ingreso no encontrado');
        return;
    }

    const nuevoUsuarioId = prompt('Ingrese el nuevo ID de usuario:', ingreso.usuario_id);
    if (nuevoUsuarioId) {
        ingreso.usuario_id = parseInt(nuevoUsuarioId);
        localStorage.setItem('gym_ingresos', JSON.stringify(ingresos));
        alert('Ingreso actualizado correctamente');
        refrescarTabla();
    }
}

// Función para eliminar un ingreso
function eliminarIngreso(id) {
    let ingresos = storage.getIngresos();
    ingresos = ingresos.filter(i => i.id !== id);
    localStorage.setItem('gym_ingresos', JSON.stringify(ingresos));
    alert('Ingreso eliminado correctamente');
    refrescarTabla();
}
</script>
</body>
</html>