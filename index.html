<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AxionFit - Sistema de Gestión de Gimnasio</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --dark-bg: #1a1d29;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
        }
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 0;
            overflow: hidden;
        }
        
        .navbar-custom {
            background: var(--dark-bg) !important;
            padding: 1rem 2rem;
            border-bottom: 3px solid #667eea;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white !important;
        }
        
        .brand-icon {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-right: 10px;
        }
        
        .dashboard-header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }
        
        .dashboard-title {
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .dashboard-subtitle {
            font-weight: 300;
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .stats-cards {
            padding: 2rem;
            background: #f8fafc;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .nav-tabs-custom {
            border: none;
            background: white;
            padding: 0 2rem;
        }
        
        .nav-tabs-custom .nav-link {
            border: none;
            border-radius: 0;
            padding: 1rem 2rem;
            font-weight: 500;
            color: var(--text-secondary);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .nav-tabs-custom .nav-link:hover {
            color: #667eea;
            background: transparent;
        }
        
        .nav-tabs-custom .nav-link.active {
            color: #667eea;
            background: transparent;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content-custom {
            padding: 2rem;
            background: white;
        }
        
        .form-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .form-control {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-custom {
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary-custom {
            background: var(--primary-gradient);
            color: white;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-outline-custom {
            border: 2px solid #667eea;
            color: #667eea;
            background: transparent;
        }
        
        .btn-outline-custom:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .table-custom {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .table-custom thead {
            background: var(--primary-gradient);
            color: white;
        }
        
        .table-custom th {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            padding: 1rem;
            border: none;
        }
        
        .table-custom td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table-custom tbody tr:hover {
            background: #f8fafc;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            position: relative;
            padding-left: 1rem;
        }
        
        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 30px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }
        
        .user-info-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .dashboard-title {
                font-size: 2rem;
            }
            
            .stats-cards {
                padding: 1rem;
            }
            
            .nav-tabs-custom .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
<!-- Login Overlay -->
<div id="loginContainer" class="position-fixed top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-dark bg-opacity-75 d-none" style="z-index:1050;">
    <div class="card p-4" style="min-width:320px; max-width:90%;">
        <h4 class="mb-3 text-center"><i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión</h4>
        <form id="formLogin" class="row g-3">
            <div class="col-12">
                <label class="form-label">Usuario</label>
                <input id="login_user" class="form-control" required>
            </div>
            <div class="col-12">
                <label class="form-label">Contraseña</label>
                <input id="login_pass" type="password" class="form-control" required>
            </div>
            <div class="col-12 d-grid gap-2">
                <button type="submit" class="btn btn-primary-custom btn-custom mt-2">Acceder</button>
            </div>
        </form>
    </div>
</div>

<div class="main-container">
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-dumbbell brand-icon"></i>
                AxionFit
            </span>
            <div class="d-flex">
                <span class="text-light me-3">
                    <i class="fas fa-user-circle me-1"></i>
                    Axionfit
                </span>
                <a href="ingresos.html" target="_blank" class="btn btn-sm btn-outline-light me-2"><i class="fas fa-door-open me-1"></i>Ingresos</a>
                <button id="btnLogout" class="btn btn-sm btn-outline-light d-none">Salir</button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-chart-line me-3"></i>
            Sistema de Gestión AxionFit
        </h1>
        <p class="dashboard-subtitle">Administra tu gimnasio de manera profesional y eficiente</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="row g-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--primary-gradient);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number" id="totalUsuarios">0</div>
                    <div class="stat-label">Miembros Activos</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--success-gradient);">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-number" id="totalIngresos">$0</div>
                    <div class="stat-label">Ingresos del Mes</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--warning-gradient);">
                        <i class="fas fa-dumbbell"></i>
                    </div>
                    <div class="stat-number" id="totalClases">0</div>
                    <div class="stat-label">Clases Disponibles</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--secondary-gradient);">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-number" id="totalInscripciones">0</div>
                    <div class="stat-label">Inscripciones Hoy</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs nav-tabs-custom" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="usuarios-tab" data-bs-toggle="tab" data-bs-target="#usuarios" type="button" role="tab">
                <i class="fas fa-users me-2"></i>Miembros
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pagos-tab" data-bs-toggle="tab" data-bs-target="#pagos" type="button" role="tab">
                <i class="fas fa-credit-card me-2"></i>Pagos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="buscar-tab" data-bs-toggle="tab" data-bs-target="#buscar" type="button" role="tab">
                <i class="fas fa-search me-2"></i>Buscar
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="clases-usuario-tab" data-bs-toggle="tab" data-bs-target="#clases-usuario" type="button" role="tab">
                <i class="fas fa-user-plus me-2"></i>Inscripciones
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="clases-tab" data-bs-toggle="tab" data-bs-target="#clases" type="button" role="tab">
                <i class="fas fa-dumbbell me-2"></i>Clases
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="ingresos.html" target="_blank" role="tab">
                <i class="fas fa-door-open me-2"></i>Ingresos
            </a>
        </li>
        <!-- Visible solo si se conoce la contraseña -->
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="#" id="btnIngresosMes" role="tab">
                <i class="fas fa-sack-dollar me-2"></i>Ingresos Mes
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content tab-content-custom" id="mainTabsContent">
        <!-- Miembros -->
        <div class="tab-pane fade show active" id="usuarios" role="tabpanel">
            <div class="section-title">Gestión de Miembros</div>
            
            <div class="form-card mb-4">
                <h5 class="mb-3"><i class="fas fa-user-plus me-2"></i>Agregar Nuevo Miembro</h5>
                <form id="formAgregarUsuario" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nombre</label>
                        <input id="nombre" name="nombre" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Apellido</label>
                        <input id="apellido" name="apellido" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Teléfono</label>
                        <input id="telefono" name="telefono" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input id="email" name="email" type="email" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Fecha de Vencimiento</label>
                        <input id="fecha_vencimiento" name="fecha_vencimiento" type="date" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">DNI</label>
                        <input id="dni" name="dni" class="form-control" required>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary-custom btn-custom me-2">
                            <i class="fas fa-plus me-2"></i>Agregar Miembro
                        </button>
                        <button type="button" id="btnMostrarUsuarios" class="btn btn-outline-custom btn-custom">
                            <i class="fas fa-list me-2"></i>Ver Todos
                        </button>
                        <button type="button" id="btnExportarDatos" class="btn btn-outline-success btn-custom ms-2">
                            <i class="fas fa-download me-2"></i>Exportar JSON
                        </button>
                        <label for="inputImportarDatos" class="btn btn-outline-primary btn-custom ms-2 mb-0">
                            <i class="fas fa-upload me-2"></i>Importar JSON
                            <input type="file" id="inputImportarDatos" accept="application/json" style="display:none;">
                        </label>
                    </div>
                </form>
            </div>

            <div id="tablaUsuariosContainer" class="d-none">
                <h5 class="mb-3"><i class="fas fa-users me-2"></i>Lista de Miembros</h5>
                <table id="tablaUsuarios" class="table table-custom">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                            <th>Vencimiento</th>
                            <th>DNI</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Pagos -->
        <div class="tab-pane fade" id="pagos" role="tabpanel">
            <div class="section-title">Gestión de Pagos</div>
            
            <div class="form-card mb-4">
                <h5 class="mb-3"><i class="fas fa-credit-card me-2"></i>Registrar Nuevo Pago</h5>
                <form id="formRegistrarPago" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">ID del Miembro</label>
                        <input id="usuario_pago" name="usuario_id" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Fecha</label>
                        <input id="fecha_pago" name="fecha" type="date" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Monto</label>
                        <input id="monto_pago" name="monto" type="number" step="0.01" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tipo de Pago</label>
                        <select id="tipo_pago" name="tipo" class="form-control" required>
                            <option value="">Seleccionar...</option>
                            <option value="Mensualidad">Mensualidad</option>
                            <option value="Inscripción">Inscripción</option>
                            <option value="Personal Training">Personal Training</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary-custom btn-custom me-2">
                            <i class="fas fa-plus me-2"></i>Registrar Pago
                        </button>
                        <button type="button" id="btnMostrarPagos" class="btn btn-outline-custom btn-custom">
                            <i class="fas fa-list me-2"></i>Ver Historial
                        </button>
                    </div>
                </form>
            </div>

            <div id="tablaPagosContainer" class="d-none">
                <h5 class="mb-3"><i class="fas fa-history me-2"></i>Historial de Pagos</h5>
                <table id="tablaPagos" class="table table-custom">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Miembro ID</th>
                            <th>Fecha</th>
                            <th>Monto</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Buscar Usuario -->
        <div class="tab-pane fade" id="buscar" role="tabpanel">
            <div class="section-title">Buscar Miembro</div>
            
            <div class="form-card mb-4">
                <h5 class="mb-3"><i class="fas fa-search me-2"></i>Buscar por ID</h5>
                <form id="formBuscarUsuario" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">ID del Miembro</label>
                        <input id="usuario_id_buscar" type="number" class="form-control" required>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary-custom btn-custom">
                            <i class="fas fa-search me-2"></i>Buscar
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="infoUsuario" class="mt-3"></div>
            <div class="mt-3 d-none" id="ingresoContainer">
                <button id="btnRegistrarIngreso" class="btn btn-success btn-custom">
                    <i class="fas fa-door-open me-2"></i>Registrar Ingreso
                </button>
                <button type="button" id="btnMostrarIngresos" class="btn btn-outline-custom btn-custom ms-2">
                    <i class="fas fa-history me-2"></i>Historial
                </button>
            </div>
        </div>

        <!-- Inscripciones -->
        <div class="tab-pane fade" id="clases-usuario" role="tabpanel">
            <div class="section-title">Inscripciones a Clases</div>
            
            <div class="form-card mb-4">
                <h5 class="mb-3"><i class="fas fa-user-plus me-2"></i>Inscribir Miembro</h5>
                <form id="formClasesUsuario" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">ID del Miembro</label>
                        <input id="usuario_clase" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Clase</label>
                        <select id="nombre_clase_usuario" class="form-control" required></select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary-custom btn-custom me-2">
                            <i class="fas fa-plus me-2"></i>Inscribir
                        </button>
                        <button type="button" id="btnMostrarClasesUsuario" class="btn btn-outline-custom btn-custom">
                            <i class="fas fa-list me-2"></i>Ver Clases del Miembro
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="listaClasesUsuarioContainer" class="d-none">
                <h5 class="mb-3"><i class="fas fa-dumbbell me-2"></i>Clases del Miembro</h5>
                <ul id="listaClasesUsuario" class="list-group"></ul>
            </div>
        </div>

        <!-- Clases -->
        <div class="tab-pane fade" id="clases" role="tabpanel">
            <div class="section-title">Gestión de Clases</div>
            
            <div class="form-card mb-4">
                <h5 class="mb-3"><i class="fas fa-dumbbell me-2"></i>Agregar Nueva Clase</h5>
                <form id="formRegistrarClase" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Nombre</label>
                        <input id="nombre_clase" name="nombre" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Descripción</label>
                        <input id="descripcion_clase" name="descripcion" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Horario</label>
                        <input id="horario_clase" name="horario" class="form-control" required>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary-custom btn-custom me-2">
                            <i class="fas fa-plus me-2"></i>Agregar Clase
                        </button>
                        <button type="button" id="btnMostrarClases" class="btn btn-outline-custom btn-custom">
                            <i class="fas fa-list me-2"></i>Ver Todas
                        </button>
                    </div>
                </form>
            </div>

            <div id="tablaClasesContainer" class="d-none">
                <h5 class="mb-3"><i class="fas fa-list me-2"></i>Lista de Clases</h5>
                <table id="tablaClases" class="table table-custom">
                    <thead>
                        <tr>
    <th>ID</th>
    <th>Nombre</th>
    <th>Descripción</th>
    <th>Horario</th>
    <th>Acciones</th>
</tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- jQuery debe cargarse antes de DataTables -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Placeholder para lógica JS -->
<script>
// SISTEMA DE ALMACENAMIENTO LOCAL
class GymStorage {
    constructor() {
        this.initializeData();
    }
    
    initializeData() {
        if (!localStorage.getItem('gym_usuarios')) {
            localStorage.setItem('gym_usuarios', JSON.stringify([]));
        }
        if (!localStorage.getItem('gym_pagos')) {
            localStorage.setItem('gym_pagos', JSON.stringify([]));
        }
        if (!localStorage.getItem('gym_clases')) {
            localStorage.setItem('gym_clases', JSON.stringify([]));
        }
        if (!localStorage.getItem('gym_inscripciones')) {
            localStorage.setItem('gym_inscripciones', JSON.stringify([]));
        }
        if (!localStorage.getItem('gym_next_id')) {
            localStorage.setItem('gym_next_id', '1');
        }
    }
    
    getNextId() {
        const id = parseInt(localStorage.getItem('gym_next_id'));
        localStorage.setItem('gym_next_id', (id + 1).toString());
        return id;
    }
    
    // USUARIOS
    getUsuarios() {
        return JSON.parse(localStorage.getItem('gym_usuarios') || '[]');
    }
    
    addUsuario(usuario) {
        const usuarios = this.getUsuarios();
        usuario.id = this.getNextId();
        usuarios.push(usuario);
        localStorage.setItem('gym_usuarios', JSON.stringify(usuarios));
        return usuario;
    }
    
    getUsuario(id) {
        const usuarios = this.getUsuarios();
        return usuarios.find(u => u.id === parseInt(id));
    }
    
    deleteUsuario(id) {
        const usuarios = this.getUsuarios();
        const filtered = usuarios.filter(u => u.id !== parseInt(id));
        localStorage.setItem('gym_usuarios', JSON.stringify(filtered));
    }
    
    // PAGOS
    getPagos() {
        return JSON.parse(localStorage.getItem('gym_pagos') || '[]');
    }
    
    addPago(pago) {
        const pagos = this.getPagos();
        pago.id = this.getNextId();
        pagos.push(pago);
        localStorage.setItem('gym_pagos', JSON.stringify(pagos));
        return pago;
    }
    
    // CLASES
    getClases() {
        return JSON.parse(localStorage.getItem('gym_clases') || '[]');
    }
    
    getClase(id) {
        const clases = this.getClases();
        return clases.find(c => c.id === parseInt(id));
    }
    
    addClase(clase) {
        const clases = this.getClases();
        clase.id = this.getNextId();
        clases.push(clase);
        localStorage.setItem('gym_clases', JSON.stringify(clases));
        return clase;
    }
    
    updateClase(id, data) {
        let clases = this.getClases();
        clases = clases.map(clase => {
            if (clase.id === parseInt(id)) {
                return { ...clase, ...data, id: parseInt(id) };
            }
            return clase;
        });
        localStorage.setItem('gym_clases', JSON.stringify(clases));
    }
    
    deleteClase(id) {
        let clases = this.getClases();
        clases = clases.filter(clase => clase.id !== parseInt(id));
        localStorage.setItem('gym_clases', JSON.stringify(clases));
    }
    
    // INSCRIPCIONES
    getInscripciones() {
        return JSON.parse(localStorage.getItem('gym_inscripciones') || '[]');
    }
    
    addInscripcion(inscripcion) {
        const inscripciones = this.getInscripciones();
        inscripcion.id = this.getNextId();
        inscripciones.push(inscripcion);
        localStorage.setItem('gym_inscripciones', JSON.stringify(inscripciones));
        return inscripcion;
    }
    
    getClasesUsuario(usuarioId) {
        const inscripciones = this.getInscripciones();
        const clases = this.getClases();
        const clasesUsuario = inscripciones
            .filter(i => i.usuario_id === parseInt(usuarioId))
            .map(i => clases.find(c => c.id === i.clase_id))
            .filter(c => c);
        return clasesUsuario;
    }

    // ===== Exportar / Importar =====
    exportAllData() {
        return {
            usuarios: this.getUsuarios(),
            pagos: this.getPagos(),
            clases: this.getClases(),
            inscripciones: this.getInscripciones(),
            ingresos: this.getIngresos ? this.getIngresos() : JSON.parse(localStorage.getItem('gym_ingresos') || '[]')
        };
    }

    importAllData(data) {
        if (data.usuarios) localStorage.setItem('gym_usuarios', JSON.stringify(data.usuarios));
        if (data.pagos) localStorage.setItem('gym_pagos', JSON.stringify(data.pagos));
        if (data.clases) localStorage.setItem('gym_clases', JSON.stringify(data.clases));
        if (data.inscripciones) localStorage.setItem('gym_inscripciones', JSON.stringify(data.inscripciones));
        if (data.ingresos) localStorage.setItem('gym_ingresos', JSON.stringify(data.ingresos));

        const allIds = [
            ...(data.usuarios?.map(u => u.id) || []),
            ...(data.pagos?.map(p => p.id) || []),
            ...(data.clases?.map(c => c.id) || []),
            ...(data.inscripciones?.map(i => i.id) || []),
            ...(data.ingresos?.map(i => i.id) || [])
        ];
        const next = allIds.length ? Math.max(...allIds) + 1 : 1;
        localStorage.setItem('gym_next_id', next.toString());
    }
}

const storage = new GymStorage();

// Utilidades
function populateClaseOptions() {
    const select = document.getElementById('nombre_clase_usuario');
    if (!select) return;
    const clases = storage.getClases();
    select.innerHTML = clases.length === 0 ? '<option value="" disabled selected>No hay clases registradas</option>' : '';
    clases.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.nombre} - ${c.horario}`;
        select.appendChild(option);
    });
}

function showContainer(id) { 
    document.getElementById(id).classList.remove("d-none"); 
}

function hideContainer(id) { 
    document.getElementById(id).classList.add("d-none"); 
}

function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.insertBefore(alertDiv, document.body.firstChild);
    setTimeout(() => alertDiv.remove(), 5000);
}

// Actualizar estadísticas
function updateStats() {
    const usuarios = storage.getUsuarios();
    const pagos = storage.getPagos();
    const clases = storage.getClases();
    
    document.getElementById('totalUsuarios').textContent = usuarios.length;
    document.getElementById('totalClases').textContent = clases.length;
    
    // Calcular ingresos del mes actual
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const monthlyIncome = pagos
        .filter(p => {
            const payDate = new Date(p.fecha);
            return payDate.getMonth() === currentMonth && payDate.getFullYear() === currentYear;
        })
        .reduce((sum, p) => sum + parseFloat(p.monto), 0);
    
    // Ocultar monto para empleados
    document.getElementById('totalIngresos').textContent = '****';
    document.getElementById('totalInscripciones').textContent = storage.getInscripciones().length;
}

// Inicialización
$(document).ready(function(){
    // ---- LOGIN HANDLING ----
    function showLogin() {
        $('#loginContainer').removeClass('d-none');
        $('#btnLogout').addClass('d-none');
    }

    function hideLogin() {
        $('#loginContainer').addClass('d-none');
        $('#btnLogout').removeClass('d-none');
    }

    // Mostrar u ocultar login según estado almacenado
    if (localStorage.getItem('gym_loggedIn') === 'true') {
        hideLogin();
    } else {
        showLogin();
    }

    // Validar formulario de inicio de sesión
    $('#formLogin').on('submit', function(e){
        e.preventDefault();
        const user = $('#login_user').val().trim();
        const pass = $('#login_pass').val().trim();

        // Credenciales por defecto
        if (user === 'Axionfit' && pass === 'Gymaxion.25') {
            localStorage.setItem('gym_loggedIn', 'true');
            hideLogin();
            showAlert('Bienvenido, Axionfit');
        } else {
            showAlert('Credenciales incorrectas', 'danger');
        }
    });

    // Cerrar sesión
    $('#btnLogout').click(function(){
        localStorage.removeItem('gym_loggedIn');
        showLogin();
    });
    // ---- END LOGIN ----

    // Cargar datos de ejemplo si es la primera vez
    if (storage.getUsuarios().length === 0) {
        // Limpiar localStorage y agregar datos de ejemplo
        localStorage.setItem('gym_usuarios', JSON.stringify([]));
        localStorage.setItem('gym_pagos', JSON.stringify([]));
        localStorage.setItem('gym_clases', JSON.stringify([]));
        localStorage.setItem('gym_inscripciones', JSON.stringify([]));
        localStorage.setItem('gym_next_id', '1');
        storage.addUsuario({
            nombre: 'Juan',
            apellido: 'Pérez',
            telefono: '123-456-7890',
            email: 'juan@email.com',
            fecha_vencimiento: '2024-12-31',
            dni: '12345678'
        });
        
        storage.addClase({
            nombre: 'Yoga',
            descripcion: 'Clase de yoga para principiantes',
            horario: 'Lunes y Miércoles 18:00'
        });
        
        storage.addClase({
            nombre: 'CrossFit',
            descripcion: 'Entrenamiento funcional de alta intensidad',
            horario: 'Martes y Jueves 19:00'
        });
    }
    
    // Cargar clases en selector
    populateClaseOptions();
    // Actualizar estadísticas al cargar
    updateStats();
    
    // DataTables para usuarios
    const tablaUsuarios = $("#tablaUsuarios").DataTable({
        destroy: true,
        columnDefs: [
            { orderable: false, targets: 7 } // Columna de acciones no ordenable
        ],
        language: {
            search: "Buscar:",
            lengthMenu: "Mostrar _MENU_ registros",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            paginate: {
                first: "Primero",
                last: "Último",
                next: "Siguiente",
                previous: "Anterior"
            },
            emptyTable: "No hay datos disponibles",
            zeroRecords: "No se encontraron registros"
        }
    });
    
    // DataTables para pagos
    const tablaPagos = $("#tablaPagos").DataTable({
        destroy: true,
        language: {
            search: "Buscar:",
            lengthMenu: "Mostrar _MENU_ registros",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            paginate: {
                first: "Primero",
                last: "Último",
                next: "Siguiente",
                previous: "Anterior"
            }
        }
    });
    
    // DataTables para clases
    const tablaClases = $("#tablaClases").DataTable({
        destroy: true,
        columnDefs: [
            { orderable: false, targets: 4 } // Columna de acciones no ordenable
        ],
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json'
        }
    });
    
    
    // MOSTRAR USUARIOS
    $('#btnMostrarUsuarios').click(() => {
        const data = storage.getUsuarios();
        tablaUsuarios.clear();
        tablaUsuarios.rows.add(data.map(u => [
            u.id ?? '',
            u.nombre ?? '',
            u.apellido ?? '',
            u.telefono ?? '',
            u.email ?? '',
            u.fecha_vencimiento ?? '',
            u.dni ?? '',
            `<button class="btn btn-sm btn-outline-primary me-1" onclick="abrirEditarUsuario(${u.id})"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="eliminarUsuario(${u.id})"><i class="fas fa-trash"></i></button>`
        ]));
        tablaUsuarios.draw();
        showContainer('tablaUsuariosContainer');
    });
    
    $('#formAgregarUsuario').submit(e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const body = Object.fromEntries(formData);
        
        storage.addUsuario(body);
        showAlert('Miembro agregado correctamente');
        e.target.reset();
        $('#btnMostrarUsuarios').click();
        updateStats();
    });
    
    // PAGOS
    $('#btnMostrarPagos').click(() => {
        const data = storage.getPagos();
        tablaPagos.clear();
        tablaPagos.rows.add(data.map(p => [
            p.id,
            p.usuario_id,
            p.fecha,
            `$${p.monto}`,
            p.tipo
        ]));
        tablaPagos.draw();
        showContainer('tablaPagosContainer');
    });
    
    $('#formRegistrarPago').submit(e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const body = Object.fromEntries(formData);
        body.monto = parseFloat(body.monto);
        body.usuario_id = parseInt(body.usuario_id);
        
        // Verificar que el usuario existe
        const usuario = storage.getUsuario(body.usuario_id);
        if (!usuario) {
            showAlert('Usuario no encontrado', 'danger');
            return;
        }
        
        storage.addPago(body);
        showAlert('Pago registrado correctamente');
        e.target.reset();
        $('#btnMostrarPagos').click();
        updateStats();
    });
    
    // BUSCAR USUARIO
    $('#formBuscarUsuario').submit(e => {
        e.preventDefault();
        const id = document.getElementById('usuario_id_buscar').value;
        const user = storage.getUsuario(id);
        
        if (user) {
            const container = document.getElementById('infoUsuario');
            const clasesUsuario = storage.getClasesUsuario(id);
            const clasesHtml = clasesUsuario.length > 0 
                ? `<div class="mt-3"><h6>Clases inscritas:</h6><ul>${clasesUsuario.map(c => `<li>${c.nombre} - ${c.horario}</li>`).join('')}</ul></div>`
                : '<div class="mt-3"><p class="text-muted">No está inscrito en ninguna clase</p></div>';
            
            // Verificar estado de vencimiento
            const vencida = estaVencida(user.fecha_vencimiento);
            const estadoClass = vencida ? 'text-danger fw-bold' : 'text-success fw-bold';
            const estadoTexto = vencida ? '⚠️ VENCIDA' : '✅ ACTIVA';
            const badgeClass = vencida ? 'bg-danger' : 'bg-success';
            const estadoBadge = vencida ? 'VENCIDA' : 'ACTIVA';
            
            container.innerHTML = `
                <div class="user-info-card ${vencida ? 'border-danger' : ''}">
                    <div class="d-flex align-items-center mb-3">
                        <div class="user-avatar me-3">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h4 class="mb-1">${user.nombre} ${user.apellido}</h4>
                            <span class="badge bg-primary me-2">ID: ${user.id}</span>
                            <span class="badge ${badgeClass}">MEMBRESÍA ${estadoBadge}</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong><i class="fas fa-phone me-2"></i>Teléfono:</strong> ${user.telefono || 'No especificado'}</p>
                            <p><strong><i class="fas fa-envelope me-2"></i>Email:</strong> ${user.email || 'No especificado'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong><i class="fas fa-calendar me-2"></i>Vencimiento:</strong> <span class="${estadoClass}">${user.fecha_vencimiento} ${estadoTexto}</span></p>
                            <p><strong><i class="fas fa-id-card me-2"></i>DNI:</strong> ${user.dni}</p>
                        </div>
                    </div>
                    ${clasesHtml}
                </div>
            `;
        } else {
            showAlert('Usuario no encontrado', 'warning');
        }
    });
    
    // CLASES
    $('#btnMostrarClases').click(() => {
        const data = storage.getClases();
        tablaClases.clear();
        tablaClases.rows.add(data.map(c => [
            c.id,
            c.nombre,
            c.descripcion,
            c.horario,
            `<button class="btn btn-sm btn-warning" onclick="abrirEditarClase(${c.id})"><i class="fas fa-edit"></i> Editar</button>
             <button class="btn btn-sm btn-danger" onclick="eliminarClase(${c.id})"><i class="fas fa-trash"></i> Eliminar</button>`
        ]));
        tablaClases.draw();
        showContainer('tablaClasesContainer');
    });
    
    $('#formRegistrarClase').submit(e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const body = Object.fromEntries(formData);
        
        storage.addClase(body);
        showAlert('Clase agregada correctamente');
        e.target.reset();
        populateClaseOptions();
        $('#btnMostrarClases').click();
        updateStats();
    });
    
    // INSCRIPCIONES
    $('#formClasesUsuario').submit(e => {
        e.preventDefault();
        const usuario_id = parseInt(document.getElementById('usuario_clase').value, 10);
        if (isNaN(usuario_id)) {
            showAlert('Ingresa un ID válido', 'warning');
            return;
        }
        const clase_id = parseInt(document.getElementById('nombre_clase_usuario').value);
        
        // Verificar que el usuario existe
        const usuario = storage.getUsuario(usuario_id);
        if (!usuario) {
            showAlert('Usuario no encontrado', 'danger');
            return;
        }
        
        // Obtener clase por ID
        const clase = storage.getClases().find(c => c.id === clase_id);
        
        if (!clase) {
            showAlert('Clase no encontrada', 'danger');
            return;
        }
        
        // Verificar si ya está inscrito
        const inscripciones = storage.getInscripciones();
        const yaInscrito = inscripciones.find(i => i.usuario_id === usuario_id && i.clase_id === clase_id);
        
        if (yaInscrito) {
            showAlert('El usuario ya está inscrito en esta clase', 'warning');
            return;
        }
        
        storage.addInscripcion({
            usuario_id: usuario_id,
            clase_id: clase_id
        });
        
        showAlert('Usuario inscrito correctamente');
        // Mostrar lista de clases del miembro actualizado
        $('#btnMostrarClasesUsuario').click();
        e.target.reset();
        updateStats();
    });
    
    // MOSTRAR CLASES DE USUARIO
    $('#btnMostrarClasesUsuario').click(() => {
        const usuario_id_raw = document.getElementById('usuario_clase').value;
        if (!usuario_id_raw) {
            showAlert('Ingresa el ID del usuario', 'warning');
            return;
        }
        const usuario_id = parseInt(usuario_id_raw, 10);
        if (isNaN(usuario_id)) {
            showAlert('Ingresa un ID válido', 'warning');
            return;
        }
        
        const usuario = storage.getUsuario(usuario_id);
        if (!usuario) {
            showAlert('Usuario no encontrado', 'danger');
            return;
        }
        
        const clasesUsuario = storage.getClasesUsuario(usuario_id);
        const container = document.getElementById('listaClasesUsuario');
        
        if (clasesUsuario.length > 0) {
            container.innerHTML = clasesUsuario.map(c => 
                `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${c.nombre}</strong><br>
                        <small class="text-muted">${c.descripcion} - ${c.horario}</small>
                    </div>
                    <span class="badge bg-primary rounded-pill">Activo</span>
                </li>`
            ).join('');
        } else {
            container.innerHTML = '<li class="list-group-item text-muted">No está inscrito en ninguna clase</li>';
        }
        
        showContainer('listaClasesUsuarioContainer');
    });


    // ====== Exportar / Importar ======>
    $('#btnExportarDatos').click(() => {
        const data = storage.exportAllData();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `axionfit_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
        a.click();
        URL.revokeObjectURL(url);
    });

    $('#inputImportarDatos').on('change', function(e){
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const data = JSON.parse(ev.target.result);
                storage.importAllData(data);
                populateClaseOptions();
                updateStats();
                showAlert('Datos importados correctamente');
                // Refrescar tablas visibles
                if(!$('#tablaUsuariosContainer').hasClass('d-none')) $('#btnMostrarUsuarios').click();
                if(!$('#tablaPagosContainer').hasClass('d-none')) $('#btnMostrarPagos').click();
                if(!$('#tablaClasesContainer').hasClass('d-none')) $('#btnMostrarClases').click();
            } catch(err){
                console.error(err);
                showAlert('Archivo JSON inválido','danger');
            }
        };
        reader.readAsText(file);
        $(this).val('');
    });
});

window.eliminarUsuario = function(id) {
    storage.deleteUsuario(id);
    showAlert('Miembro eliminado correctamente');
    $('#btnMostrarUsuarios').click();
    updateStats();
}

window.eliminarClase = function(id) {
    if (!confirm('¿Seguro que deseas eliminar esta clase?')) return;
    storage.deleteClase(id);
    showAlert('Clase eliminada correctamente');
    $('#btnMostrarClases').click();
    updateStats();
}


// ======= EDICIÓN DE MIEMBROS =======
if(!GymStorage.prototype.updateUsuario){
    GymStorage.prototype.updateUsuario = function(id, data){
        const usuarios = this.getUsuarios();
        const idx = usuarios.findIndex(u => parseInt(u.id) === parseInt(id));
        if(idx>-1){
        usuarios[idx] = {...usuarios[idx], ...data, id: parseInt(id, 10)};
        localStorage.setItem('gym_usuarios', JSON.stringify(usuarios));
        }
    };
}

window.abrirEditarUsuario = function(id){
    const usuario = storage.getUsuario(id);
    if(!usuario){showAlert('Usuario no encontrado','danger');return;}
    // Rellenar campos del modal
    $('#edit_usuario_id').val(usuario.id);
    $('#edit_nombre').val(usuario.nombre);
    $('#edit_apellido').val(usuario.apellido);
    $('#edit_telefono').val(usuario.telefono);
    $('#edit_email').val(usuario.email);
    $('#edit_fecha_vencimiento').val(usuario.fecha_vencimiento);
    $('#edit_dni').val(usuario.dni);
    new bootstrap.Modal(document.getElementById('modalEditarUsuario')).show();
};

$(document).off('submit', '#formEditarUsuario').on('submit', '#formEditarUsuario', function(e){
    e.preventDefault();
    const id = parseInt($('#edit_usuario_id').val(),10);
    const data = {
        nombre: $('#edit_nombre').val(),
        apellido: $('#edit_apellido').val(),
        telefono: $('#edit_telefono').val(),
        email: $('#edit_email').val(),
        fecha_vencimiento: $('#edit_fecha_vencimiento').val(),
        dni: $('#edit_dni').val()
    };
    storage.updateUsuario(id, data);
    showAlert('Miembro actualizado correctamente');
    const tablaUsuarios = $("#tablaUsuarios").DataTable();
    tablaUsuarios.clear();
    tablaUsuarios.rows.add(storage.getUsuarios().map(u => [
        u.id ?? '',
        u.nombre ?? '',
        u.apellido ?? '',
        u.telefono ?? '',
        u.email ?? '',
        u.fecha_vencimiento ?? '',
        u.dni ?? '',
        `<button class="btn btn-sm btn-outline-primary me-1" onclick="abrirEditarUsuario(${u.id})"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="eliminarUsuario(${u.id})"><i class="fas fa-trash"></i></button>`
    ]));
    tablaUsuarios.draw();
    bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario')).hide();
    updateStats();
});
// ======= FIN EDICIÓN MIEMBROS =======

// ======= EDICIÓN DE CLASES =======
window.abrirEditarClase = function(id){
    const clase = storage.getClase(id);
    if(!clase){showAlert('Clase no encontrada','danger');return;}
    // Rellenar campos del modal
    $('#editar_id_clase').val(clase.id);
    $('#editar_nombre_clase').val(clase.nombre);
    $('#editar_descripcion_clase').val(clase.descripcion);
    $('#editar_horario_clase').val(clase.horario);
    new bootstrap.Modal(document.getElementById('modalEditarClase')).show();
};

$(document).off('submit', '#formEditarClase').on('submit', '#formEditarClase', function(e){
    e.preventDefault();
    const id = parseInt($('#editar_id_clase').val(),10);
    const data = {
        nombre: $('#editar_nombre_clase').val(),
        descripcion: $('#editar_descripcion_clase').val(),
        horario: $('#editar_horario_clase').val()
    };
    storage.updateClase(id, data);
    showAlert('Clase actualizada correctamente');
    
    const tablaClases = $("#tablaClases").DataTable();
    tablaClases.clear();
    tablaClases.rows.add(storage.getClases().map(c => [
        c.id,
        c.nombre,
        c.descripcion,
        c.horario,
        `<button class="btn btn-sm btn-warning" onclick="abrirEditarClase(${c.id})"><i class="fas fa-edit"></i> Editar</button>
         <button class="btn btn-sm btn-danger" onclick="eliminarClase(${c.id})"><i class="fas fa-trash"></i> Eliminar</button>`
    ]));
    tablaClases.draw();
    
    bootstrap.Modal.getInstance(document.getElementById('modalEditarClase')).hide();
    updateStats();
});
// ======= FIN EDICIÓN CLASES =======

// ========== INGRESOS (registro de entradas) ==========
$('#ingresoContainer').addClass('d-none');

function showIngresoButton(uid){
    $('#ingresoContainer').removeClass('d-none');
    $('#btnRegistrarIngreso').data('uid', uid);
}

if(!GymStorage.prototype.getIngresos){
    GymStorage.prototype.getIngresos = function(){
        return JSON.parse(localStorage.getItem('gym_ingresos')||'[]');
    };
    GymStorage.prototype.addIngreso = function(ing){
        const arr = this.getIngresos();
        ing.id = this.getNextId();
        arr.push(ing);
        localStorage.setItem('gym_ingresos', JSON.stringify(arr));
    };
}

// Función para verificar si una membresía está vencida
function estaVencida(fechaVencimiento) {
    const hoy = new Date();
    const vencimiento = new Date(fechaVencimiento);
    return vencimiento < hoy;
}

// Función para formatear fecha en español
function formatearFecha(fecha) {
    return new Date(fecha).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

$('#btnRegistrarIngreso').on('click', function(){
    const uid = $(this).data('uid');
    const usuario = storage.getUsuario(uid);
    if(!usuario){
        showAlert('Usuario no encontrado', 'danger');
        return;
    }
    
    // Verificar si la membresía está vencida
    if (estaVencida(usuario.fecha_vencimiento)) {
        const mensaje = `⚠️ ATENCIÓN: La membresía de ${usuario.nombre} ${usuario.apellido} está vencida desde el ${formatearFecha(usuario.fecha_vencimiento)}.\n\n¿Desea permitir el ingreso de manera excepcional?`;
        
        if (confirm(mensaje)) {
            storage.addIngreso({
                usuario_id: uid, 
                fecha: new Date().toISOString(),
                excepcional: true
            });
            showAlert('⚠️ Ingreso EXCEPCIONAL registrado (Membresía vencida)', 'warning');
        } else {
            showAlert('Ingreso cancelado - Membresía vencida', 'danger');
        }
        return;
    }
    
    // Si no está vencida, registrar ingreso normalmente
    storage.addIngreso({usuario_id: uid, fecha: new Date().toISOString()});
    showAlert('✅ Ingreso registrado correctamente', 'success');
});

let tablaIngresos;
$('#btnMostrarIngresos').click(function(){
    if(!tablaIngresos){
        tablaIngresos = $('#tablaIngresos').DataTable({
            destroy:true,
            language:{search:'Buscar:',lengthMenu:'Mostrar _MENU_ registros',info:'Mostrando _START_ a _END_ de _TOTAL_ registros',paginate:{first:'Primero',last:'Último',next:'Siguiente',previous:'Anterior'},emptyTable:'Sin ingresos registrados',zeroRecords:'Sin coincidencias'}
        });
    }
    const ingresos = storage.getIngresos();
    tablaIngresos.clear();
    tablaIngresos.rows.add(ingresos.map(i=>[i.id,i.usuario_id,new Date(i.fecha).toLocaleString('es-ES')]));
    tablaIngresos.draw();
    new bootstrap.Modal(document.getElementById('historialIngresosModal')).show();
});
// =====================================================
</script>

<!-- Modal Editar Miembro -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Miembro</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formEditarUsuario">
        <div class="modal-body">
          <input type="hidden" id="edit_usuario_id">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" id="edit_nombre" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Apellido</label>
            <input type="text" id="edit_apellido" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Teléfono</label>
            <input type="text" id="edit_telefono" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="edit_email" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Fecha Vencimiento</label>
            <input type="date" id="edit_fecha_vencimiento" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">DNI</label>
            <input type="text" id="edit_dni" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary-custom btn-custom">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Editar Clase -->
<div class="modal fade" id="modalEditarClase" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Clase</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formEditarClase">
        <div class="modal-body">
          <input type="hidden" id="editar_id_clase">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" id="editar_nombre_clase" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripción</label>
            <input type="text" id="editar_descripcion_clase" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Horario</label>
            <input type="text" id="editar_horario_clase" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary-custom btn-custom">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Historial Ingresos -->
<div class="modal fade" id="historialIngresosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-door-open me-2"></i>Historial de Ingresos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table id="tablaIngresos" class="table table-custom w-100">
          <thead>
            <tr>
              <th>ID</th>
              <th>Miembro ID</th>
              <th>Fecha/Hora</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Acceso oculto para dueños (no visible para empleados)
// Combinación Ctrl+Shift+I solicita contraseña y abre ingresos_mes.html
(function(){
  const OWNER_PASS='Empresa24.'; // misma clave que en ingresos_mes.html
  // Atajo oculto
  document.addEventListener('keydown',e=>{
    if(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='i')){
      e.preventDefault();
      solicitarClave();
    }
  });
  // Click en enlace del menú
  const link=document.getElementById('btnIngresosMes');
  if(link){link.addEventListener('click',e=>{e.preventDefault();solicitarClave();});}

  function solicitarClave(){
      const pw=prompt('Acceso Dueños - Ingresar contraseña:');
      if(pw===OWNER_PASS){window.open('ingresos_mes.html','_blank');}
      else if(pw!==null){alert('Contraseña incorrecta');}
  }
})();
</script>
</body>
</html>
